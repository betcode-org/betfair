
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Lightweight, super fast (uses c libraries) pythonic wrapper for Betfair API-NG.">
      
      
      
      
        <link rel="prev" href="../endpoints/">
      
      
        <link rel="next" href="../advanced/">
      
      
      <link rel="icon" href="../images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Streaming - betfairlightweight</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#streaming" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="betfairlightweight" class="md-header__button md-logo" aria-label="betfairlightweight" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            betfairlightweight
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Streaming
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/betcode-org/betfair" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    betcode-org/betfair
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="betfairlightweight" class="md-nav__button md-logo" aria-label="betfairlightweight" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    betfairlightweight
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/betcode-org/betfair" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    betcode-org/betfair
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    QuickStart
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../endpoints/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Endpoints
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Streaming
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Streaming
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-streaming" class="md-nav__link">
    <span class="md-ellipsis">
      Why streaming?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#market" class="md-nav__link">
    <span class="md-ellipsis">
      Market
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#order" class="md-nav__link">
    <span class="md-ellipsis">
      Order
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#order-matches" class="md-nav__link">
    <span class="md-ellipsis">
      Order - Matches
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#historical" class="md-nav__link">
    <span class="md-ellipsis">
      Historical
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snap" class="md-nav__link">
    <span class="md-ellipsis">
      Snap
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resubscribe" class="md-nav__link">
    <span class="md-ellipsis">
      Resubscribe
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listener" class="md-nav__link">
    <span class="md-ellipsis">
      Listener
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Usage
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../help/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Help
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-streaming" class="md-nav__link">
    <span class="md-ellipsis">
      Why streaming?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#market" class="md-nav__link">
    <span class="md-ellipsis">
      Market
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#order" class="md-nav__link">
    <span class="md-ellipsis">
      Order
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#order-matches" class="md-nav__link">
    <span class="md-ellipsis">
      Order - Matches
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#historical" class="md-nav__link">
    <span class="md-ellipsis">
      Historical
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snap" class="md-nav__link">
    <span class="md-ellipsis">
      Snap
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resubscribe" class="md-nav__link">
    <span class="md-ellipsis">
      Resubscribe
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listener" class="md-nav__link">
    <span class="md-ellipsis">
      Listener
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="streaming">Streaming</h1>
<h3 id="why-streaming">Why streaming?</h3>
<p>If your aim is to take a snapshot of horse markets 3 minutes before the off and at post time, polling (listMarketBook) is a good solution. You will only hit the Betfair API endpoint 2 times per market.
But if you want to gather, process and react to data more frequently (e.g. in-play horse racing), polling is inefficient and the reason lies in the way HTTP works. Every time you hit a Betfair API endpoint:</p>
<ul>
<li>Your machine establishes a new connection with the Betfair server.</li>
<li>It sends an HTTP request and receives and HTTP response.</li>
<li>HTTP requests/responses carry headers, so more data is sent/received.</li>
</ul>
<p>Streaming is more efficient because:</p>
<ul>
<li>The connection gets established once.</li>
<li>From that moment, data keeps flowing from Betfair to your machine.</li>
<li>There are no data overheads as you would have with polling / HTTP.</li>
<li>This results in faster data and less CPU from your machine (and Betfair's)</li>
</ul>
<p>The full docs can be found <a href="https://docs.developer.betfair.com/display/1smk3cen4v3lu3yomq5qye0ni/Exchange+Stream+API">here</a></p>
<h3 id="market">Market</h3>
<p>A market stream can be created like so:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">betfairlightweight</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.filters</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">streaming_market_filter</span><span class="p">,</span>
    <span class="n">streaming_market_data_filter</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">app_key</span><span class="o">=</span><span class="s2">&quot;appKey&quot;</span><span class="p">)</span>
<span class="n">trading</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>

<span class="c1"># create queue</span>
<span class="n">output_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

<span class="c1"># create stream listener</span>
<span class="n">listener</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">StreamListener</span><span class="p">(</span><span class="n">output_queue</span><span class="o">=</span><span class="n">output_queue</span><span class="p">)</span>

<span class="c1"># create stream</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_stream</span><span class="p">(</span><span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">)</span>

<span class="c1"># create filters (GB WIN racing)</span>
<span class="n">market_filter</span> <span class="o">=</span> <span class="n">streaming_market_filter</span><span class="p">(</span>
    <span class="n">event_type_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;7&quot;</span><span class="p">],</span> <span class="n">country_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GB&quot;</span><span class="p">],</span> <span class="n">market_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;WIN&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">market_data_filter</span> <span class="o">=</span> <span class="n">streaming_market_data_filter</span><span class="p">(</span>
    <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;EX_BEST_OFFERS&quot;</span><span class="p">,</span> <span class="s2">&quot;EX_MARKET_DEF&quot;</span><span class="p">],</span> <span class="n">ladder_levels</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>

<span class="c1"># subscribe</span>
<span class="n">streaming_unique_id</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">subscribe_to_markets</span><span class="p">(</span>
    <span class="n">market_filter</span><span class="o">=</span><span class="n">market_filter</span><span class="p">,</span>
    <span class="n">market_data_filter</span><span class="o">=</span><span class="n">market_data_filter</span><span class="p">,</span>
    <span class="n">conflate_ms</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>  <span class="c1"># send update every 1000ms</span>
<span class="p">)</span>

<span class="c1"># start stream in a new thread (in production would need err handling)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># check for updates in output queue</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">market_books</span> <span class="o">=</span> <span class="n">output_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">market_books</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">market_book</span><span class="p">,</span>
            <span class="n">market_book</span><span class="o">.</span><span class="n">streaming_unique_id</span><span class="p">,</span>  <span class="c1"># unique id of stream (returned from subscribe request)</span>
            <span class="n">market_book</span><span class="o">.</span><span class="n">streaming_update</span><span class="p">,</span>  <span class="c1"># json update received</span>
            <span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="p">,</span>  <span class="c1"># streaming definition, similar to catalogue request</span>
            <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">,</span>  <span class="c1"># betfair publish time of update</span>
        <span class="p">)</span>
</code></pre></div>

<h3 id="order">Order</h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The order stream does not include matched positions, these can be found by making a getCurrentOrders request. However 'price point' matched backs and matched lays are stored in the order cache in matched_lays / matched_backs.</p>
</div>
<p>Order stream is similar to market:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">betfairlightweight</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">streaming_order_filter</span>

<span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">app_key</span><span class="o">=</span><span class="s2">&quot;appKey&quot;</span><span class="p">)</span>
<span class="n">trading</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>

<span class="c1"># create queue</span>
<span class="n">output_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

<span class="c1"># create stream listener</span>
<span class="n">listener</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">StreamListener</span><span class="p">(</span><span class="n">output_queue</span><span class="o">=</span><span class="n">output_queue</span><span class="p">)</span>

<span class="c1"># create stream</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_stream</span><span class="p">(</span><span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">)</span>

<span class="c1"># create filters (GB WIN racing)</span>
<span class="n">order_filter</span> <span class="o">=</span> <span class="n">streaming_order_filter</span><span class="p">()</span>

<span class="c1"># subscribe</span>
<span class="n">streaming_unique_id</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">subscribe_to_orders</span><span class="p">(</span>
    <span class="n">order_filter</span><span class="o">=</span><span class="n">order_filter</span><span class="p">,</span>
    <span class="n">conflate_ms</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>  <span class="c1"># send update every 1000ms</span>
<span class="p">)</span>

<span class="c1"># start stream in a new thread (in production would need err handling)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># check for updates in output queue</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">current_orders</span> <span class="o">=</span> <span class="n">output_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">current_orders</span><span class="p">)</span>
</code></pre></div>

<h3 id="order-matches">Order - Matches</h3>
<p>In addition to <code>orders</code> and the <code>moreAvailable</code> flag the streaming output has a <code>matches</code> field which contains a list of the selections with <code>matchedBacks</code> and <code>matchedLays</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">current_orders</span><span class="o">.</span><span class="n">matches</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">bettingresources</span><span class="o">.</span><span class="n">Match</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">bettingresources</span><span class="o">.</span><span class="n">Match</span><span class="o">&gt;</span><span class="p">]</span>
</code></pre></div>

<h3 id="historical">Historical</h3>
<p>Betfairlightweight can also handle historical streaming data that has been purchased from <a href="https://historicdata.betfair.com/#/home">Betfair</a> or collected yourself. </p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>

    <span class="c1"># create listener</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">StreamListener</span><span class="p">(</span><span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># create historical stream, update file_path to file location</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_stream</span><span class="p">(</span>
        <span class="n">file_path</span><span class="o">=</span><span class="s2">&quot;/tmp/BASIC-1.132153978&quot;</span><span class="p">,</span>
        <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># start stream</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stream</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The streaming code is highly optimised however to further improve speed the <code>update_clk</code> flag can be set to False on the listener <code>StreamListener(update_clk=False)</code> however update_clk is required to be True when live streaming (resubscribe uses it).</p>
</div>
<p>The historical stream can be used in the same way as the market/order stream allowing backtesting / market processing.</p>
<p>It is also possible to return a generator instead which can be easier to use (no threads) and uses less ram:</p>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># create historical generator stream, update directory to file location</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
        <span class="n">file_path</span><span class="o">=</span><span class="s2">&quot;/tmp/BASIC-1.132153978&quot;</span><span class="p">,</span>
        <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># create genertaor</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">g</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">market_books</span><span class="p">)</span>

<span class="p">[</span><span class="o">&lt;</span><span class="n">MarketBook</span><span class="o">&gt;</span><span class="p">]</span>
<span class="o">..</span>
</code></pre></div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When using betfair purchased historical data the listener vars <code>calculate_market_tv</code> and <code>cumulative_runner_tv</code> are required to access <code>totalMatched</code> in the market and runner books (depending on data package)</p>
</div>
<h3 id="snap">Snap</h3>
<p>Instead of waiting for an update you can snap the listener to get an up to date version of the data.</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">market_books</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="n">snap</span><span class="p">(</span>
        <span class="n">market_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;1.12345323&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The streaming unique id is returned in the marketBook / orderBook which allows multiple streams to be differentiated if multiple streams feed into the same queue.</p>
<p><code>market_book.streaming_unique_id</code></p>
</div>
<h3 id="resubscribe">Resubscribe</h3>
<p>If you have lost connection and need to resubscribe (prevents a full image being sent) you can provide the following:</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">streaming_unique_id</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">subscribe_to_markets</span><span class="p">(</span>
        <span class="n">market_filter</span><span class="o">=</span><span class="n">market_filter</span><span class="p">,</span>
        <span class="n">market_data_filter</span><span class="o">=</span><span class="n">market_data_filter</span><span class="p">,</span>
        <span class="n">conflate_ms</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>  <span class="c1"># send update every 1000ms</span>
        <span class="n">initial_clk</span><span class="o">=</span><span class="n">listener</span><span class="o">.</span><span class="n">initial_clk</span><span class="p">,</span>
        <span class="n">clk</span><span class="o">=</span><span class="n">listener</span><span class="o">.</span><span class="n">clk</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>

<h3 id="error-handling">Error Handling</h3>
<p>When used in production it is recommended not to start the stream in a new thread and forgot about it, it will break, errors need to be caught. </p>
<p>Please see the example <a href="https://github.com/betcode-org/betfair/tree/master/examples/examplestreamingerrhandling.py">examplestreamingerrhandling.py</a></p>
<p>Sometimes betfair will suspend the stream via the use of a status=503 update, more info <a href="https://docs.developer.betfair.com/display/1smk3cen4v3lu3yomq5qye0ni/Exchange+Stream+API#ExchangeStreamAPI-StreamAPIStatus-latency">here</a>, when the stream is receiving this update the <code>listener.status</code> will be updated:</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">listener</span><span class="o">.</span><span class="n">status</span>
<span class="mi">503</span>
</code></pre></div>

<h3 id="listener">Listener</h3>
<p>You can create a custom listener by overriding the listener class:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">betfairlightweight</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyListener</span><span class="p">(</span><span class="n">betfairlightweight</span><span class="o">.</span><span class="n">StreamListener</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>


<span class="n">custom_listener</span> <span class="o">=</span> <span class="n">MyListener</span><span class="p">()</span>
</code></pre></div>

<h3 id="logging">Logging</h3>
<p>In order to debug the stream update the logging level to DEBUG:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</code></pre></div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>By default <code>max_latency</code> is set to 0.5, this means a warning will be logged if the latency between the publishTime and your machines time is greater than this number. Often you will need to check that your clock is up to date, however this can be removed by setting <code>max_latency=None</code> when initializing the listener.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>